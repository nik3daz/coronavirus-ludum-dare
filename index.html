<!DOCTYPE html>
<html>
<head>
    <title>Coronavirus game</title>
    <!-- <script src="node_modules/pixi.js/dist/pixi.js"></script> -->
    <!-- <script src="node_modules/planck-js/dist/planck.js"></script> -->
    <script src="planck-with-testbed.js"></script>
    <!-- <script src="dist/index.js"></script> -->

    <style>
        html, body { margin:0; width:100%; height:100%; }
    </style>
</head>
<body>

    <script type="text/javascript">
        planck.testbed(function (testbed) {
            var pl = planck, Vec2 = pl.Vec2;
            var world = new pl.World(Vec2(0, -10));

            var COUNT = 7;

            var sensor;
            var bodies = [];
            var touching = [];

            var ground = world.createBody();
            ground.createFixture(pl.Edge(Vec2(-200.0, 0.0), Vec2(200.0, 0.0)), 0.0);

            if (0) {
                sensor = ground.createFixture({
                    shape: pl.Box(10.0, 2.0, Vec2(0.0, 20.0), 0.0),
                    isSensor: true,
                });

            } else {
                sensor = ground.createFixture({
                    shape: pl.Circle(Vec2(0.0, 10.0), 5.0),
                    isSensor: true,
                });
            }

            var circle = pl.Circle(1.0);

            for (var i = 0; i < COUNT; ++i) {
                touching[i] = { touching: false };

                bodies[i] = world.createDynamicBody(Vec2(-10.0 + 3.0 * i, 20.0));
                bodies[i].setUserData(touching[i])
                bodies[i].createFixture(circle, 1.0);
            }

            // Implement contact listener.
            world.on('begin-contact', function (contact) {
                var fixtureA = contact.getFixtureA();
                var fixtureB = contact.getFixtureB();

                if (fixtureA === sensor) {
                    var userData = fixtureB.getBody().getUserData();
                    if (userData) {
                        userData.touching = true;
                    }
                }

                if (fixtureB === sensor) {
                    var userData = fixtureA.getBody().getUserData();
                    if (userData) {
                        userData.touching = true;
                    }
                }
            });

            // Implement contact listener.
            world.on('end-contact', function (contact) {
                var fixtureA = contact.getFixtureA();
                var fixtureB = contact.getFixtureB();

                if (fixtureA === sensor) {
                    var userData = fixtureB.getBody().getUserData();
                    if (userData) {
                        userData.touching = false;
                    }
                }

                if (fixtureB === sensor) {
                    var userData = fixtureA.getBody().getUserData();
                    if (userData) {
                        userData.touching = false;
                    }
                }
            });

            testbed.step = function () {
                // Traverse the contact results. Apply a force on shapes
                // that overlap the sensor.
                for (var i = 0; i < COUNT; ++i) {
                    if (!touching[i].touching) {
                        continue;
                    }

                    var body = bodies[i];
                    var ground = sensor.getBody();

                    var circle = sensor.getShape();
                    var center = ground.getWorldPoint(circle.getCenter());

                    var position = body.getPosition();

                    var d = Vec2.sub(center, position);
                    if (d.lengthSquared() < pl.Math.EPSILON * pl.Math.EPSILON) {
                        continue;
                    }

                    d.normalize();
                    var F = Vec2.mul(d, 300.0);
                    body.applyForce(F, position, false);
                }
            };

            return world;
        });
    </script>

    <!-- <script type="text/javascript">
        let type = "WebGL"
        if (!PIXI.utils.isWebGLSupported()) { type = "canvas" }

        PIXI.utils.sayHello(type)

        // Can we set resolution to some fraction to get a pixel art effect?
        // http://pixijs.download/release/docs/PIXI.Application.html
        let app = new PIXI.Application({
                antialias: false,    // default: false
                transparent: false, // default: false
                resizeTo: document.getElementsByTagName("body")[0],
                resolution: 1       // default: 1
            });
        app.renderer.backgroundColor = 0x061639;
        app.renderer.view.style.position = "absolute";
        app.renderer.view.style.display = "block";
        
        app.renderer.autoDensity = true;
        // https://github.com/kittykatattack/scaleToWindow
        // We could use this to scale the canvas proportionally to any browser window size

        // Add the canvas that Pixi automatically created for you to the HTML document
        document.body.appendChild(app.view);

        // http://pixijs.download/release/docs/PIXI.Loader.html
        const loader = PIXI.Loader.shared;
        loader.add("img/water.jpg", "img/floor05.jpg", "wood_05_texture.jpg",
            "img/cube-1.png", "img/cube-2.png", "img/cube-3.png", 
            "img/cube-3-noshadow.png");

        // The `load` method loads the queue of resources, and calls the passed in callback called once all
        // resources have loaded.
        loader.load((loader, resources) => {
            // sprites.scoreFont = new PIXI.TilingSprite(resources.scoreFont.texture);
        });

    </script> -->

</body>
</html>